<!DOCTYPE html><html lang="en"> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><link rel="icon" type="image/ico" href="/favicon.ico"><link rel="stylesheet" href="https://cdn.vidstack.io/player.css"><meta name="generator" content="Astro v5.1.1"><title>Laurent Kempé</title><link rel="stylesheet" href="/_astro/_slug_.YV223W5U.css">
<style>a[data-astro-cid-5grsw2hi]{color:#00539f}.tags[data-astro-cid-5grsw2hi]{display:flex;flex-wrap:wrap}.tag[data-astro-cid-5grsw2hi]{margin:.25em;border:dotted 1px #a1a1a1;border-radius:.5em;padding:.5em 1em;font-size:1.15em;background-color:#f8fcfd}
[data-astro-image]{width:100%;height:auto;-o-object-fit:var(--fit);object-fit:var(--fit);-o-object-position:var(--pos);object-position:var(--pos);aspect-ratio:var(--w) / var(--h)}[data-astro-image=responsive]{max-width:calc(var(--w) * 1px);max-height:calc(var(--h) * 1px)}[data-astro-image=fixed]{width:calc(var(--w) * 1px);height:calc(var(--h) * 1px)}
</style></head> <body> <header class="py-6 border-b container mx-auto px-4 sm:px-6 lg:px-8 max-w-7xl"> <nav class="container mx-auto px-4 flex flex-col sm:flex-row items-center justify-between"> <div class="text-2xl font-bold mb-4 sm:mb-0"> <a href="/">Laurent Kempé</a> </div> <div class="flex gap-6 text-gray-600"> <a href="/" class="hover:text-gray-900 ">Home</a> <a href="/blog" class="hover:text-gray-900 ">Blog</a> <a href="/speaking" class="hover:text-gray-900 ">Speaking</a> <a href="/about-laurent-kempe" class="hover:text-gray-900 ">About</a> </div> </nav> </header> <div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-7xl">  <p data-astro-cid-5grsw2hi>Tue Mar 16</p> <p data-astro-cid-5grsw2hi><em data-astro-cid-5grsw2hi></em></p> <img src="https://live.staticflickr.com/4399/36332910612_10d4a7d2da_h.jpg" width="600" alt="Matamata, Hobbiton, New Zealand" data-astro-cid-5grsw2hi>Matamata, Hobbiton, New Zealand <article class="prose prose-lg max-w-none dark:prose-invert
             prose-h1:font-bold prose-h1:text-xl
             prose-a:text-blue-600 prose-p:text-justify prose-img:rounded-xl
             prose-headings:underline"> <h1>Service to service invocation with Dapr .NET SDK</h1> <p>In the previous two posts, we tackled the way to start with Dapr and how to call services. In this one, we will see how we can leverage the Dapr .NET SDK to handle service to service calls.</p>
<ul>
<li><a href="https://laurentkempe.com/2021/03/09/getting-started-with-dapr-for-dotnet-developers/">Getting started with Dapr for .NET Developers</a></li>
<li><a href="https://laurentkempe.com/2021/03/11/using-service-invocation-from-dapr-dotnet-sdk/">Using Service Invocation from Dapr .NET SDK</a></li>
</ul>
<!-- more -->
<h1 id="introduction">Introduction</h1>
<p>The example in this blog post is quite simple. It focuses on the main topic which is to see how you can do service to service invocation with Dapr .NET SDK. We have two services implemented in C# ASP.NET exposing REST API, one named <strong>proxy</strong> and the second <strong>backend</strong>. <strong>proxy</strong> is calling <strong>backend</strong> using Dapr .NET SDK.</p>
<p>Note that both services could be implemented in different languages on different platforms, nevertheless, the principles would be the same.</p>
<h1 id="backend-service">Backend service</h1>
<p>Nothing special here, it is the normal WeatherService from the default webapi .NET template, in the project WeatherForecastService. We just start it using Dapr and expose it under the name <strong>backend</strong>. That’s one of the beauties of Dapr, you don’t need to change your service to expose through a Dapr sidecar.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="powershell"><code><span class="line"><span style="color:#79B8FF">dapr.exe</span><span style="color:#E1E4E8"> run </span><span style="color:#F97583">--</span><span style="color:#E1E4E8">app</span><span style="color:#F97583">-</span><span style="color:#E1E4E8">id backend </span><span style="color:#F97583">--</span><span style="color:#E1E4E8">app</span><span style="color:#F97583">-</span><span style="color:#E1E4E8">port </span><span style="color:#79B8FF">5000</span><span style="color:#F97583"> --</span><span style="color:#E1E4E8">dapr</span><span style="color:#F97583">-</span><span style="color:#E1E4E8">http</span><span style="color:#F97583">-</span><span style="color:#E1E4E8">port </span><span style="color:#79B8FF">3500</span><span style="color:#F97583"> --</span><span style="color:#E1E4E8">app</span><span style="color:#F97583">-</span><span style="color:#E1E4E8">ssl dotnet run </span><span style="color:#F97583">--</span><span style="color:#F97583"> --</span><span style="color:#E1E4E8">urls</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">https:</span><span style="color:#F97583">//</span><span style="color:#E1E4E8">localhost:</span><span style="color:#79B8FF">5000</span><span style="color:#F97583">/</span><span style="color:#F97583"> -</span><span style="color:#E1E4E8">p WeatherForecastService</span><span style="color:#F97583">/</span><span style="color:#E1E4E8">WeatherForecastService.csproj</span></span></code></pre>
<p>Again, we can access our web API using its URI, <a href="https://localhost:5000/swagger/index.html">https://localhost:5000/swagger/index.html</a> and <a href="https://localhost:5000/WeatherForecast/">https://localhost:5000/WeatherForecast/</a> but what we want is that it can be called through Dapr at <a href="http://localhost:3500/v1.0/invoke/backend/method/weatherforecast">http://localhost:3500/v1.0/invoke/backend/method/weatherforecast</a>.</p>
<h1 id="proxy-service">Proxy service</h1>
<p>Here is the interesting part of this post. The <strong>backend</strong> service call is encapsulated in a client interface in the project WeatherForecastProxyService.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="csharp"><code><span class="line"><span style="color:#F97583">    public</span><span style="color:#F97583"> interface</span><span style="color:#B392F0"> IWeatherForecastClient</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#B392F0">        Task</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">IEnumerable</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">WeatherForecast</span><span style="color:#E1E4E8">>> </span><span style="color:#B392F0">GetWeatherForecast</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">int</span><span style="color:#B392F0"> count</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span></code></pre>
<p>The implementation of the interface is straightforward and the interesting part is that it gets an <em>HttpClient</em> injected through its constructor which can call our <strong>backend</strong> service by using only the ‘&#x3C;method-name>’ of our service, in this case, <em>weatherforecast</em>.</p>
<p>The clear benefit is that the client only focuses on the API it is calling and not where it is located, this is delegated to <em>backendHttpClient</em>.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="csharp"><code><span class="line"><span style="color:#F97583">    public</span><span style="color:#F97583"> class</span><span style="color:#B392F0"> WeatherForecastClient</span><span style="color:#E1E4E8"> : </span><span style="color:#B392F0">IWeatherForecastClient</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#F97583">        private</span><span style="color:#F97583"> readonly</span><span style="color:#B392F0"> HttpClient</span><span style="color:#B392F0"> _backendHttpClient</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">        public</span><span style="color:#B392F0"> WeatherForecastClient</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">HttpClient</span><span style="color:#B392F0"> backendHttpClient</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">        {</span></span>
<span class="line"><span style="color:#E1E4E8">            _backendHttpClient </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> backendHttpClient;</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">        public</span><span style="color:#F97583"> async</span><span style="color:#B392F0"> Task</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">IEnumerable</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">WeatherForecast</span><span style="color:#E1E4E8">>> </span><span style="color:#B392F0">GetWeatherForecast</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">int</span><span style="color:#B392F0"> count</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">        {</span></span>
<span class="line"><span style="color:#F97583">            var</span><span style="color:#B392F0"> weatherForecasts</span><span style="color:#F97583"> =</span></span>
<span class="line"><span style="color:#F97583">                await</span><span style="color:#E1E4E8"> _backendHttpClient.</span><span style="color:#B392F0">GetFromJsonAsync</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">List</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">WeatherForecast</span><span style="color:#E1E4E8">>>(</span><span style="color:#9ECBFF">"weatherforecast"</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">            return</span><span style="color:#E1E4E8"> weatherForecasts</span><span style="color:#F97583">?</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Take</span><span style="color:#E1E4E8">(count);</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span></code></pre>
<p>To be able to inject the <strong>backendHttpClient</strong> into our client class we configure the ASP.NET IOC container, taking advantage of Dapr .NET SDK to create the HttpClient using the Dapr <strong>appid</strong> <em>backend</em> which was used to start our backend service through Dapr. This is the way that the <em>HttpClient</em> knows how to call our <strong>backend</strong> service and decoupling it from its real address, letting Dapr handle the resolution of its location.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="csharp"><code><span class="line"><span style="color:#F97583">        public</span><span style="color:#F97583"> void</span><span style="color:#B392F0"> ConfigureServices</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">IServiceCollection</span><span style="color:#B392F0"> services</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">        {</span></span>
<span class="line"><span style="color:#F97583">            ..</span><span style="color:#E1E4E8">.</span></span>
<span class="line"><span style="color:#E1E4E8">            services.</span><span style="color:#B392F0">AddSingleton</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">IWeatherForecastClient</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">WeatherForecastClient</span><span style="color:#E1E4E8">>(</span></span>
<span class="line"><span style="color:#B392F0">                _</span><span style="color:#F97583"> =></span><span style="color:#F97583"> new</span><span style="color:#B392F0"> WeatherForecastClient</span><span style="color:#E1E4E8">(DaprClient.</span><span style="color:#B392F0">CreateInvokeHttpClient</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"backend"</span><span style="color:#E1E4E8">)));</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span></code></pre>
<p>Finally, we are injecting the client interface into the proxy controller so that we can use it in the controller method and call our <strong>backend</strong> service</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="csharp"><code><span class="line"><span style="color:#E1E4E8">    [</span><span style="color:#B392F0">ApiController</span><span style="color:#E1E4E8">]</span></span>
<span class="line"><span style="color:#E1E4E8">    [</span><span style="color:#B392F0">Route</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"[controller]"</span><span style="color:#E1E4E8">)]</span></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#F97583"> class</span><span style="color:#B392F0"> WeatherForecastProxyController</span><span style="color:#E1E4E8"> : </span><span style="color:#B392F0">ControllerBase</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#F97583">        private</span><span style="color:#F97583"> readonly</span><span style="color:#B392F0"> IWeatherForecastClient</span><span style="color:#B392F0"> _weatherForecastClient</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">        public</span><span style="color:#B392F0"> WeatherForecastProxyController</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">IWeatherForecastClient</span><span style="color:#B392F0"> weatherForecastClient</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">        {</span></span>
<span class="line"><span style="color:#E1E4E8">            _weatherForecastClient </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> weatherForecastClient;</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">        [</span><span style="color:#B392F0">HttpGet</span><span style="color:#E1E4E8">]</span></span>
<span class="line"><span style="color:#F97583">        public</span><span style="color:#F97583"> async</span><span style="color:#B392F0"> Task</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">IEnumerable</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">WeatherForecast</span><span style="color:#E1E4E8">>> </span><span style="color:#B392F0">Get</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">int</span><span style="color:#B392F0"> count</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">        {</span></span>
<span class="line"><span style="color:#F97583">            return</span><span style="color:#F97583"> await</span><span style="color:#E1E4E8"> _weatherForecastClient.</span><span style="color:#B392F0">GetWeatherForecast</span><span style="color:#E1E4E8">(count);</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span></code></pre>
<p>We start it using Dapr and expose it under the name <strong>proxy</strong>.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="powershell"><code><span class="line"><span style="color:#79B8FF">dapr.exe</span><span style="color:#E1E4E8"> run </span><span style="color:#F97583">--</span><span style="color:#E1E4E8">app</span><span style="color:#F97583">-</span><span style="color:#E1E4E8">id proxy </span><span style="color:#F97583">--</span><span style="color:#E1E4E8">app</span><span style="color:#F97583">-</span><span style="color:#E1E4E8">port </span><span style="color:#79B8FF">5001</span><span style="color:#F97583"> --</span><span style="color:#E1E4E8">dapr</span><span style="color:#F97583">-</span><span style="color:#E1E4E8">http</span><span style="color:#F97583">-</span><span style="color:#E1E4E8">port </span><span style="color:#79B8FF">3501</span><span style="color:#F97583"> --</span><span style="color:#E1E4E8">app</span><span style="color:#F97583">-</span><span style="color:#E1E4E8">ssl dotnet run </span><span style="color:#F97583">--</span><span style="color:#F97583"> --</span><span style="color:#E1E4E8">urls</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">https:</span><span style="color:#F97583">//</span><span style="color:#E1E4E8">localhost:</span><span style="color:#79B8FF">5001</span><span style="color:#F97583">/</span><span style="color:#F97583"> -</span><span style="color:#E1E4E8">p WeatherForecastProxyService</span><span style="color:#F97583">/</span><span style="color:#E1E4E8">WeatherForecastProxyService.csproj</span></span></code></pre>
<p>We can also access the proxy web API using its URI, <a href="https://localhost:5001/swagger/index.html">https://localhost:5001/swagger/index.html</a>, and <a href="https://localhost:5001/WeatherForecastProxy?count=2">https://localhost:5001/WeatherForecastProxy?count=2</a> but what we want is that it can be called through Dapr too at <a href="http://localhost:3501/v1.0/invoke/proxy/method/weatherforecastproxy?count=2">http://localhost:3501/v1.0/invoke/proxy/method/weatherforecastproxy?count=2</a>.</p>
<h1 id="starting-proxy-and-backend-dapr-sidecar">Starting proxy and backend Dapr sidecar</h1>
<p>You can use the <code>start.ps1</code> PowerShell script if you have Windows Terminal installed, and it will display side by side both outputs in a new full-screen window. On the left is the <strong>proxy</strong> sidecar output and on the right the <strong>backend</strong>.</p>
<h1 id="calling-the-proxy">Calling the proxy</h1>
<p>As I wrote previously, you can access the <strong>proxy</strong> API through its Dapr sidecar at <a href="http://localhost:3501/v1.0/invoke/proxy/method/weatherforecastproxy?count=2">http://localhost:3501/v1.0/invoke/proxy/method/weatherforecastproxy?count=2</a>.
It is interesting to note that it is also accessible through the <strong>backend</strong> sidecar at <a href="http://localhost:3500/v1.0/invoke/proxy/method/weatherforecastproxy?count=2">http://localhost:3500/v1.0/invoke/proxy/method/weatherforecastproxy?count=2</a>, notice the port number difference from <em>3501</em> to <em>3500</em>.</p>
<!--?! alert info ?-->
<p>This means that the Dapr runtime handles correctly the routing of our call to the correct service.</p>
<!--?!/ alert ?-->
<p>Here is the result</p>
<p><img src="https://live.staticflickr.com/65535/51034623513_011b0ca0c1_c.jpg" alt="Calling the proxy"></p>
<h1 id="conclusion">Conclusion</h1>
<p>In this post, we saw again how easy it is to get the advantage of <a href="https://dapr.io/">Dapr</a> and its <a href="https://github.com/dapr/dotnet-sdk">Dapr .NET SDK</a> to ease our developer work and focus on the functionalities of our application and delegate the infrastructure work to Dapr, in that case, the service location again.</p>
<p>You can get access to the code of this blog post on GitHub in the <a href="https://github.com/laurentkempe/daprPlayground/tree/master/ServiceToService">ServiceToService folder</a></p>
<p></p>
<!--?# githubCard user=laurentkempe repo=daprPlayground align=left /?--> </article>  <div class="tags" data-astro-cid-5grsw2hi> <p class="tag" data-astro-cid-5grsw2hi><a href="/tags/ASP.NET Core" data-astro-cid-5grsw2hi>ASP.NET Core</a></p><p class="tag" data-astro-cid-5grsw2hi><a href="/tags/.NET" data-astro-cid-5grsw2hi>.NET</a></p><p class="tag" data-astro-cid-5grsw2hi><a href="/tags/Dapr" data-astro-cid-5grsw2hi>Dapr</a></p> </div>  </div> <footer class="py-8"> <div class="container mx-auto gap-4 px-4 text-sm text-gray-600 text-center"> <div>
&copy; 2024 Laurent Kempé. All rights reserved.
</div> <div>
The expressed opinions are my own and do not reflect those of my employer or any third-party entities.
</div> </div> </footer> <script src="https://cdn.vidstack.io/player.core" type="module"></script> <script src="https://cdn.vidstack.io/icons" type="module"></script> </body> </html> 