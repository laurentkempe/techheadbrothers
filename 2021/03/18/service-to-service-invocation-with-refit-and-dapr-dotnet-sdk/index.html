<!DOCTYPE html><html lang="en"> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><link rel="icon" type="image/ico" href="/favicon.ico"><meta name="generator" content="Astro v5.1.1"><title>Laurent Kempé</title><link rel="stylesheet" href="/_astro/_slug_.DnmLDlos.css">
<style>a[data-astro-cid-5grsw2hi]{color:#00539f}.tags[data-astro-cid-5grsw2hi]{display:flex;flex-wrap:wrap}.tag[data-astro-cid-5grsw2hi]{margin:.25em;border:dotted 1px #a1a1a1;border-radius:.5em;padding:.5em 1em;font-size:1.15em;background-color:#f8fcfd}
[data-astro-image]{width:100%;height:auto;-o-object-fit:var(--fit);object-fit:var(--fit);-o-object-position:var(--pos);object-position:var(--pos);aspect-ratio:var(--w) / var(--h)}[data-astro-image=responsive]{max-width:calc(var(--w) * 1px);max-height:calc(var(--h) * 1px)}[data-astro-image=fixed]{width:calc(var(--w) * 1px);height:calc(var(--h) * 1px)}
</style></head> <body> <header class="py-6 border-b container mx-auto px-4 sm:px-6 lg:px-8 max-w-7xl"> <nav class="container mx-auto px-4 flex flex-col sm:flex-row items-center justify-between"> <div class="text-2xl font-bold mb-4 sm:mb-0"> <a href="/">Laurent Kempé</a> </div> <div class="flex gap-6 text-gray-600"> <a href="/" class="hover:text-gray-900 ">Home</a> <a href="/blog" class="hover:text-gray-900 ">Blog</a> <a href="/speaking" class="hover:text-gray-900 ">Speaking</a> <a href="/about-laurent-kempe" class="hover:text-gray-900 ">About</a> </div> </nav> </header> <div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-7xl">  <p data-astro-cid-5grsw2hi>Thu Mar 18</p> <p data-astro-cid-5grsw2hi><em data-astro-cid-5grsw2hi></em></p> <img src="https://live.staticflickr.com/2672/32885107145_a73724e5cf_h.jpg" width="600" alt="Anse Caffard, Martinique, France" data-astro-cid-5grsw2hi>Anse Caffard, Martinique, France <article class="prose prose-lg max-w-none dark:prose-invert
             prose-h1:font-bold prose-h1:text-xl
             prose-a:text-blue-600 prose-p:text-justify prose-img:rounded-xl
             prose-headings:underline"> <h1>Service to service invocation with Refit and Dapr .NET SDK</h1> <p>In the last post, we have seen how to <a href="https://laurentkempe.com/2021/03/16/service-to-service-invocation-with-dapr-dotnet-sdk/">call a service from another service using the Dapr .NET SDK</a>. In this one, we will have a look at a possible way to simplify the development of the client code using <a href="https://reactiveui.github.io/refit/">Refit</a>, the automatic type-safe REST library for .NET Core, Xamarin, and .NET.</p>
<!-- more -->
<h1 id="introduction">Introduction</h1>
<p>Refit is a library heavily inspired by Square’s <a href="http://square.github.io/retrofit">Retrofit</a> library, and it turns your REST API into a live interface! It generates for you an implementation of the interface that uses HttpClient to make its calls.
Coupled to the <a href="https://github.com/dapr/dotnet-sdk">Dapr .NET SDK</a> it is a great candidate to reduce the amount of code you need to write to call your Dapr services. And we all know, less code means fewer bugs.</p>
<h1 id="proxy-service">Proxy service</h1>
<p>The only difference from the previous blog post source code for the <code>IWeatherForecastClient</code> interface is that we decorate the interface with a <em>Get</em> attribute coming from Refit and specifying the method on the service which is called, here <em>weatherforecast</em>.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="csharp"><code><span class="line"><span style="color:#F97583">using</span><span style="color:#B392F0"> System</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Collections</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Generic</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">using</span><span style="color:#B392F0"> System</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Threading</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Tasks</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">using</span><span style="color:#B392F0"> Refit</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">namespace</span><span style="color:#B392F0"> WeatherForecastProxyService</span></span>
<span class="line"><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#F97583"> interface</span><span style="color:#B392F0"> IWeatherForecastClient</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#E1E4E8">        [</span><span style="color:#B392F0">Get</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"/weatherforecast"</span><span style="color:#E1E4E8">)]</span></span>
<span class="line"><span style="color:#B392F0">        Task</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">IEnumerable</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">WeatherForecast</span><span style="color:#E1E4E8">>> </span><span style="color:#B392F0">GetWeatherForecast</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">int</span><span style="color:#B392F0"> count</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>As previously, we inject the interface in our web API controller of our first service, so that it can call the second service.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="csharp"><code><span class="line"><span style="color:#E1E4E8">    [</span><span style="color:#B392F0">ApiController</span><span style="color:#E1E4E8">]</span></span>
<span class="line"><span style="color:#E1E4E8">    [</span><span style="color:#B392F0">Route</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"[controller]"</span><span style="color:#E1E4E8">)]</span></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#F97583"> class</span><span style="color:#B392F0"> WeatherForecastProxyController</span><span style="color:#E1E4E8"> : </span><span style="color:#B392F0">ControllerBase</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#F97583">        private</span><span style="color:#F97583"> readonly</span><span style="color:#B392F0"> IWeatherForecastClient</span><span style="color:#B392F0"> _weatherForecastClient</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">        public</span><span style="color:#B392F0"> WeatherForecastProxyController</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">IWeatherForecastClient</span><span style="color:#B392F0"> weatherForecastClient</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">        {</span></span>
<span class="line"><span style="color:#E1E4E8">            _weatherForecastClient </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> weatherForecastClient;</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">        [</span><span style="color:#B392F0">HttpGet</span><span style="color:#E1E4E8">]</span></span>
<span class="line"><span style="color:#F97583">        public</span><span style="color:#F97583"> async</span><span style="color:#B392F0"> Task</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">IEnumerable</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">WeatherForecast</span><span style="color:#E1E4E8">>> </span><span style="color:#B392F0">Get</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">int</span><span style="color:#B392F0"> count</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">        {</span></span>
<span class="line"><span style="color:#F97583">            return</span><span style="color:#F97583"> await</span><span style="color:#E1E4E8"> _weatherForecastClient.</span><span style="color:#B392F0">GetWeatherForecast</span><span style="color:#E1E4E8">(count);</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span></code></pre>
<p>Finally, we need to configure the ASP.NET IOC container, so that it can inject the client based on <code>IWeatherForecastClient</code> created by Refit into the controller. Again, we leverage the Dapr .NET SDK to create the HttpClient using the Dapr appid <em>backend</em> which was used to start our backend service through Dapr. This is the way that the HttpClient knows how to call our <em>backend</em> service and decoupling it from its real address, letting Dapr handle the resolution of its location.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="csharp"><code><span class="line"><span style="color:#F97583">    public</span><span style="color:#F97583"> void</span><span style="color:#B392F0"> ConfigureServices</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">IServiceCollection</span><span style="color:#B392F0"> services</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#F97583">        ..</span><span style="color:#E1E4E8">.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">        services.</span><span style="color:#B392F0">AddSingleton</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#B392F0">            _</span><span style="color:#F97583"> =></span><span style="color:#E1E4E8"> RestService.</span><span style="color:#B392F0">For</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">IWeatherForecastClient</span><span style="color:#E1E4E8">>(</span></span>
<span class="line"><span style="color:#E1E4E8">                     DaprClient.</span><span style="color:#B392F0">CreateInvokeHttpClient</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"backend"</span><span style="color:#E1E4E8">)));</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span></code></pre>
<p>Here is the same result</p>
<p><img src="https://live.staticflickr.com/65535/51034623513_011b0ca0c1_c.jpg" alt="Calling the proxy using Refit"></p>
<h1 id="conclusion">Conclusion</h1>
<p>In this post, we used <a href="https://reactiveui.github.io/refit/">Refit</a> to simplify the development of the client code needed to call a Dapr service.</p>
<p>You can get access to the code of this blog post on GitHub in the <a href="https://github.com/laurentkempe/daprPlayground/tree/master/ServiceToServiceRefit">ServiceToService Refit</a> folder.</p>
<p></p>
<!--?# githubCard user=laurentkempe repo=daprPlayground align=left /?--> </article>  <div class="tags" data-astro-cid-5grsw2hi> <p class="tag" data-astro-cid-5grsw2hi><a href="/tags/.NET" data-astro-cid-5grsw2hi>.NET</a></p><p class="tag" data-astro-cid-5grsw2hi><a href="/tags/ASP.NET Core" data-astro-cid-5grsw2hi>ASP.NET Core</a></p><p class="tag" data-astro-cid-5grsw2hi><a href="/tags/Dapr" data-astro-cid-5grsw2hi>Dapr</a></p> </div>  </div> <footer class="py-8"> <div class="container mx-auto gap-4 px-4 text-sm text-gray-600 text-center"> <div>
&copy; 2024 Laurent Kempé. All rights reserved.
</div> <div>
The expressed opinions are my own and do not reflect those of my employer or any third-party entities.
</div> </div> </footer> </body></html> 